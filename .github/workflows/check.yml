name: Check Tag

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    # UTC Êó∂Èó¥ 4 ÁÇπ 00 ÂàÜÔºåÂåó‰∫¨Êó∂Èó¥ 12 ÁÇπ 00 ÂàÜ
    - cron: "00 16,4 * * *"

jobs:
  export-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Áî®‰∫éÂèëÂ∏É release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Check TAG
        shell: bash
        run: |
          if [-f ./VERSION]; then
              echo "üõë VERSION file does not exist"
              exit 1
          fi
          if [ -f ./version_list ]; then
              rm -rf version_list
          fi
          cat VERSION | sort -Vu -o version_list
          echo "Latest versions:"
          cat version_list | while read version_list; do
              HAVE_TAG=false

              for tag in $(git tag); do
                  if [ "${version_list}" == "${tag}" ]; then
                      HAVE_TAG=true
                      break
                  fi
              done

              if ! ${HAVE_TAG}; then
                  echo "Creating and pushing tag ${version_list}"
                  git tag ${version_list}
                  git push origin ${version_list}
              else
                  echo "Tag ${version_list} already exists, skipping"
              fi
          done
      - name: Trigger export workflow
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"new-tag-pushed"}'