name: Check Tag

on:
  workflow_dispatch:
  push:
    branches:
      - main
  schedule:
    # UTC æ—¶é—´ 4 ç‚¹ 00 åˆ†ï¼ŒåŒ—äº¬æ—¶é—´ 12 ç‚¹ 00 åˆ†
    - cron: "00 16,4 * * *"

jobs:
  export-images:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç”¨äºå‘å¸ƒ release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Check TAG
        shell: bash
        run: |
          if [ ! -f ./VERSION ]; then
              echo "ğŸ›‘ VERSION file does not exist"
              exit 1
          fi

          # ç¡®ä¿ç‰ˆæœ¬åˆ—è¡¨æ˜¯å”¯ä¸€å¹¶æ’åºçš„
          sort -Vu VERSION -o version_list

          # è®°å½•è¦æ¨é€çš„æ–° tag
          new_tags=""

          # æ£€æŸ¥æ¯ä¸ªç‰ˆæœ¬æ˜¯å¦å·²æœ‰ tag
          while read -r version; do
              if git rev-parse "refs/tags/$version" >/dev/null 2>&1; then
                  echo "âœ… Tag $version already exists, skipping"
              else
                  echo "ğŸ·ï¸ Creating tag $version"
                  git tag "$version"
                  new_tags="$new_tags $version"
              fi
          done < version_list

          # å¦‚æœæœ‰æ–° tagï¼Œæ¨é€å®ƒä»¬
          if [ -n "$new_tags" ]; then
              echo "ğŸš€ Pushing new tags: $new_tags"
              git remote set-url origin https://x-access-token:${{ secrets.PERSONAL_TOKEN }}@github.com/${{ github.repository }}
              git push origin $new_tags
          else
              echo "âœ¨ No new tags to push."
          fi
          