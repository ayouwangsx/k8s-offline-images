name: Build and Push K8s Images

on:
  workflow_run:
    workflows: ["Check Tag"]
    types:
      - completed
  push:
    tags:
      - 'v*'

jobs:
  export-images:
    runs-on: ubuntu-latest
    permissions:
      # ç”¨äºŽå‘å¸ƒ release
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure Git user
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Extract version from tag
        id: version
        run: echo "K8S_VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ env.K8S_VERSION }}
          release_name: Release ${{ env.K8S_VERSION }}
          body: |
            ðŸš€ fix: Kubernetes ${{ env.K8S_VERSION }}.
          draft: false
          prerelease: false

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Install containerd
        run: |
          sudo apt-get update
          sudo apt-get install -y containerd

          sudo mkdir -p /etc/containerd
          sudo containerd config default | sudo tee /etc/containerd/config.toml
          
          sudo systemctl restart containerd
          sudo systemctl enable containerd

      - name: Install kubeadm
        run: |
          K8S_VERSION_NUM=${K8S_VERSION#v}
          sudo apt-get update
          sudo apt-get install -y apt-transport-https ca-certificates curl
          sudo echo "deb [trusted=yes] https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list > /dev/null
          sudo apt-get update --allow-unauthenticated
          # èŽ·å–å®Œæ•´ç‰ˆæœ¬å·
          DEB_KUBEADM_VERSION=$(apt-cache madison kubeadm | grep ${K8S_VERSION_NUM} | head -n1 | awk '{print $3}')
          if [ -z "$DEB_KUBEADM_VERSION" ]; then
            echo "âŒ kubeadm version ${K8S_VERSION_NUM} not found!"
            exit 1
          fi
          sudo apt-get install -y kubeadm=$DEB_KUBEADM_VERSION kubelet=$DEB_KUBEADM_VERSION kubectl=$DEB_KUBEADM_VERSION --allow-unauthenticated --allow-downgrades

      - name: Save images to tarball
        run: |
          # èŽ·å–æ‰€æœ‰çš„é•œåƒåˆ—è¡¨
          IMAGES=$(sudo kubeadm config images list --kubernetes-version $K8S_VERSION)
          # å®šä¹‰åŽ‹ç¼©æ–‡ä»¶å
          FILE="k8s-${K8S_VERSION}-amd64.tar.gz"
          # æ‹‰å–é•œåƒ
          for img in $IMAGES; do
            sudo ctr images pull $img
          done
          # ä¿å­˜é•œåƒ
          sudo ctr images export $FILE $IMAGES
          echo "ARCHIVE_NAME=$FILE" >> $GITHUB_ENV

      - name: Upload image archive to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ARCHIVE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}